{% extends "base.html" %}
{% block content %}
<h2>销售收银</h2>
<div class="row">
    <div class="col-md-8">
        <!-- 条码输入 / 扫描 -->
        <div class="input-group mb-3">
            <input type="text" id="barcode-input" class="form-control" placeholder="扫描或输入条码/ID" autofocus>
            <button class="btn btn-outline-secondary" type="button" id="add-by-barcode">添加</button>
            <button class="btn btn-outline-info" type="button" id="start-scanner" data-bs-toggle="modal" data-bs-target="#scannerModal">摄像头扫描</button>
        </div>
        <!-- 购物车表格 -->
        <table class="table table-bordered" id="cart-table">
            <thead>
                <tr><th>ID</th><th>商品名</th><th>单价</th><th>数量</th><th>小计</th><th>操作</th></tr>
            </thead>
            <tbody id="cart-body"></tbody>
        </table>
        <button class="btn btn-primary" id="checkout-btn">结算并打印小票</button>
    </div>
</div>

<!-- 摄像头扫描模态框 -->
<div class="modal fade" id="scannerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">条码扫描</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <video id="preview" width="100%" style="border:1px solid #ccc;"></video>
            </div>
        </div>
    </div>
</div>

<!-- 销售记录列表（可选） -->
<h3 class="mt-4">最近销售记录</h3>
<table class="table table-sm">
    <thead><tr><th>ID</th><th>商品</th><th>数量</th><th>单价</th><th>日期</th></tr></thead>
    <tbody>
        {% for s in sales %}
        <tr><td>{{ s[0] }}</td><td>{{ s[1] }}</td><td>{{ s[2] }}</td><td>{{ s[3] }}</td><td>{{ s[4] }}</td></tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{% block scripts %}
<!-- Instascan 扫描库 -->
<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script>
let cart = [];

// 根据条码获取商品信息
function fetchProduct(barcode) {
    fetch(`/api/product/${barcode}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                addToCart(data);
            }
        })
        .catch(err => alert('请求失败'));
}

// 添加到购物车
function addToCart(product) {
    let existing = cart.find(item => item.id === product.id);
    if (existing) {
        existing.quantity += 1;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1
        });
    }
    renderCart();
}

// 渲染购物车
function renderCart() {
    let tbody = document.getElementById('cart-body');
    tbody.innerHTML = '';
    let total = 0;
    cart.forEach((item, index) => {
        let subtotal = item.price * item.quantity;
        total += subtotal;
        tbody.innerHTML += `<tr>
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.price.toFixed(2)}</td>
            <td><input type="number" value="${item.quantity}" min="1" data-index="${index}" class="quantity-input form-control form-control-sm" style="width:80px;"></td>
            <td>${subtotal.toFixed(2)}</td>
            <td><button class="btn btn-sm btn-danger" data-index="${index}">删除</button></td>
        </tr>`;
    });
    // 合计行
    tbody.innerHTML += `<tr><td colspan="4" class="text-end">合计：</td><td colspan="2">${total.toFixed(2)}</td></tr>`;

    // 绑定事件
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            let idx = this.dataset.index;
            cart[idx].quantity = parseInt(this.value) || 1;
            renderCart();
        });
    });
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.addEventListener('click', function() {
            let idx = this.dataset.index;
            cart.splice(idx, 1);
            renderCart();
        });
    });
}

// 手动添加按钮
document.getElementById('add-by-barcode').addEventListener('click', () => {
    let barcode = document.getElementById('barcode-input').value.trim();
    if (barcode) {
        fetchProduct(barcode);
        document.getElementById('barcode-input').value = '';
    }
});

document.getElementById('barcode-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('add-by-barcode').click();
    }
});

// 摄像头扫描
let scanner = null;
document.getElementById('start-scanner').addEventListener('click', function() {
    if (!scanner) {
        scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
        scanner.addListener('scan', function(content) {
            document.getElementById('barcode-input').value = content;
            fetchProduct(content);
            // 可选自动关闭模态框
            let modal = bootstrap.Modal.getInstance(document.getElementById('scannerModal'));
            modal.hide();
        });
        Instascan.Camera.getCameras().then(function(cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]); // 默认后置摄像头
            } else {
                alert('未检测到摄像头');
            }
        }).catch(console.error);
    }
});

// 结算
document.getElementById('checkout-btn').addEventListener('click', () => {
    if (cart.length === 0) {
        alert('购物车为空');
        return;
    }
    fetch('/api/sale/checkout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ items: cart })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/receipt/${data.sale_id}`;
        } else {
            alert('结算失败：' + data.error);
        }
    })
    .catch(err => alert('请求失败'));
});
</script>
{% endblock %}